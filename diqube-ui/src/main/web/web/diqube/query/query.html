<!--

    diqube: Distributed Query Base.

    Copyright (C) 2015 Bastian Gloeckle

    This file is part of diqube.

    diqube is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

-->
<h1 class="page-header">Query</h1>

<span class="text-muted">Execute a single query.</span>

<p><textarea [(ngModel)]="diql" rows="6" class="diql-full"> </textarea></p>
<div class="execute-buttons">
  <button class="btn btn-primary" (click)="execute()" [disabled]="isExecuting">Execute</button>
  <button class="btn btn-primary" (click)="cancel()" [disabled]="!isExecuting">Cancel</button>

  <div *ngIf="stats" class="btn-toolbar pull-right">
    <div class="btn-group">
      <button type="button" class="btn btn-default" (click)="switchToDisplayResults()">Results</button>
      <button type="button" class="btn btn-default" (click)="switchToDisplayStats()">Statistics</button>
    </div>
  </div>
</div>

<div *ngIf="displayAnything()">
  <span>
    Progress: {{ result.percentComplete }}%
  </span>
  
  <table *ngIf="displayResults()" class="table table-striped">
    <thead>
      <tr>
        <th *ngFor="#colName of result.columnNames">{{colName}}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="#row of result.rows">
        <td *ngFor="#col of row">{{col}}</td>
      </tr>
    </tbody>
  </table>
  
  <table *ngIf="displayStats()" class="table table-striped">
    <thead>
      <tr>
        <th></th>
        <th></th>
        <th *ngFor="#nodeName of stats.nodeNames">{{nodeName}}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="2">startedUntilDoneMs</td>
        <td *ngFor="#val of stats.startedUntilDoneMs">{{val}}</td>
      </tr>
      <tr>
        <td colspan="2">numberOfThreads</td>
        <td *ngFor="#val of stats.numberOfThreads">{{val}}</td>
      </tr>    
      <tr>
        <td colspan="2">numberOfTemporaryColumnShardsCreated</td>
        <td *ngFor="#val of stats.numberOfTemporaryColumnShardsCreated">{{val}}</td>
      </tr>    
      <tr>
        <td colspan="2">numberOfTemporaryColumnShardsFromCache</td>
        <td *ngFor="#val of stats.numberOfTemporaryColumnShardsFromCache">{{val}}</td>
      </tr>    
      <tr>
        <td colspan="2">numberOfPagesInTable</td>
        <td *ngFor="#val of stats.numberOfPagesInTable">{{val}}</td>
      </tr>    
      <tr>
        <td colspan="2">numberOfTemporaryPages</td>
        <td *ngFor="#val of stats.numberOfTemporaryPages">{{val}}</td>
      </tr>
      <tr *ngFor="#item of (stats.numberOfPageAccesses | iterateMapSorted); #i = index">
        <td [attr.rowspan]="(stats.numberOfPageAccesses | iterateMapSorted).length" *ngIf="i == 0">numberOfPageAccesses</td>
        <td title="{{ item.key }}">{{item.key | limitTo: 100}}</td>
        <td *ngFor="#val of item.value">{{val}}</td>
      </tr>
      <tr *ngFor="#item of (stats.numberOfTemporaryPageAccesses | iterateMapSorted); #i = index">
        <td [attr.rowspan]="(stats.numberOfTemporaryPageAccesses | iterateMapSorted).length" *ngIf="i == 0">numberOfTemporaryPageAccesses</td>
        <td title="{{ item.key }}">{{item.key | limitTo: 100}}</td>
        <td *ngFor="#val of item.value">{{val}}</td>
      </tr>
      <tr *ngFor="#item of (stats.numberOfTemporaryVersionsPerColName | iterateMapSorted); #i = index">
        <td [attr.rowspan]="(stats.numberOfTemporaryVersionsPerColName | iterateMapSorted).length" *ngIf="i == 0">numberOfTemporaryVersionsPerColName</td>
        <td title="{{ item.key }}">{{item.key | limitTo: 100}}</td>
        <td *ngFor="#val of item.value">{{val}}</td>
      </tr>
      <tr *ngFor="#item of (stats.stepsActiveMs | iterateMapSorted); #i = index">
        <td [attr.rowspan]="(stats.stepsActiveMs | iterateMapSorted).length" *ngIf="i == 0">stepsActiveMs</td>
        <td title="{{ item.key }}">{{item.key | limitTo: 100}}</td>
        <td *ngFor="#val of item.value">{{val}}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="exception" class="alert alert-danger">
  <i class="fa fa-exclamation-circle"></i>
  {{ exception }}
</div>