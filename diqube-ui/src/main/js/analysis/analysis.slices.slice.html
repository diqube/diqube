<!--

    diqube: Distributed Query Base.

    Copyright (C) 2015 Bastian Gloeckle

    This file is part of diqube.

    diqube is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

-->
<div ng-if="!editMode" class="panel panel-default slice {{ additionalClass }}">
  <div class="panel-heading">
    <span>{{ slice.name }}</span>
    <span class="slice-header-actions">
      <a href class="slice-header-action" title="Edit mode" ng-click="toggleEditMode()"><i class="fa fa-gears"></i></a>
    </span>
  </div>
  
  <ul class="list-group" ng-if="slice.manualConjunction">
    <li class="list-group-item">{{ slice.manualConjunction }}</li>
  </ul>
  <table class="table table-condensed">
    <tbody>
      <tr ng-repeat="dis in slice.sliceDisjunctions" class="{{ (!$first || slice.manualConjunction) ? 'slice-tr-show-and' : '' }}">
        <td class="slice-disjunction-field" colspan="dis.disjunctionValues.length">{{ dis.fieldName }}</td>
        <td class="slice-disjunction-value-td">
          <ul class="list-group slice-disjunction-value-list">
            <li class="list-group-item slice-disjunction-value {{ $first ? 'slice-disjunction-value-first' : 'slice-disjunction-value-show-or' }}" 
                ng-repeat="val in dis.disjunctionValues">{{ val }}</li>
          </ul>
        </td>
      </tr>
    </tbody>
  </table>
</div>


<!-- EDIT MODE -->

<div ng-if="editMode" class="edit-slice panel panel-default slice {{ additionalClass }}">
  <form novalidate class="simple-form" ng-submit="updateSlice(sliceCopy)">
    <input type="submit" class="hidden">
    <div class="panel-heading">
      <div class="has-feedback form-group {{ nameValid === true ? 'has-success' : '' }} {{ nameValid === false ? 'has-error' : '' }}">
        <input type="text" class="form-control" id="inputName"
          placeholder="Name of query" ng-model="sliceCopy.name" 
          ng-change="validateName(sliceCopy.name)">
        <span ng-if="nameValid === true" class="fa fa-check form-control-feedback"></span>
        <span ng-if="nameValid === false" class="fa fa-exclamation-triangle form-control-feedback"></span>
      </div>
      
      <span class="slice-header-actions">
          <a ng-if="!working" href class="slice-header-action" title="Cancel edit" ng-click="toggleEditMode()"><i class="fa fa-close"></i></a>
          <a ng-if="!working" href class="slice-header-action" title="Save" ng-click="updateSlice(sliceCopy)"><i class="fa fa-floppy-o"></i></a>
          <i ng-if="working" class="slice-header-action fa fa-spinner fa-spin"></i>
      </span>
    </div>
    
    <div ng-if="editException" class="panel-body">
      <div class="alert alert-danger">
        <i class="fa fa-exclamation-circle"></i>
        {{ editException }}
      </div>
    </div>
    
    <ul class="list-group">
      <li class="list-group-item">
        <div class="form-group">
          <input type="text" class="form-control" id="inputManualConjunction"
            placeholder="Manual conjunction" ng-model="sliceCopy.manualConjunction">
        </div>
      </li>
    </ul>
    <table class="table table-condensed">
      <tbody>
        <tr ng-repeat="dis in sliceCopy.sliceDisjunctions track by $index" class="slice-tr-show-and">
        
          <td class="slice-disjunction-field" colspan="dis.disjunctionValues.length">
            <span>{{ dis.fieldName }}</span>&nbsp;
            <a href title="Remove field" ng-click="removeDisjunctionField(sliceCopy, $index)">
              <i class="fa fa-minus remove-action"></i>
            </a>
          </td>
          
          <td class="slice-disjunction-value-td">
            <ul class="list-group slice-disjunction-value-list">
            
              <li class="list-group-item slice-disjunction-value {{ $first ? 'slice-disjunction-value-first' : 'slice-disjunction-value-show-or' }}" 
                  ng-repeat="val in dis.disjunctionValues track by $index">
                <span class="has-feedback form-group slice-value-group {{ isDisjunctionValueValid(val) === true ? 'has-success' : '' }} {{ isDisjunctionValueValid(val) === false ? 'has-error' : '' }}">
                  <input type="text" class="form-control" ng-attr-id="slice.id + '-' + $parent.$index + '-' + $index"
                    placeholder="Value" ng-model="dis.disjunctionValues[$index]">
                  <span ng-if="isDisjunctionValueValid(val) === true" class="fa fa-check form-control-feedback"></span>
                  <span ng-if="isDisjunctionValueValid(val) === false" class="fa fa-exclamation-triangle form-control-feedback"></span>
                  <div class="slice-value-group-actions">
                    <a href class="slice-value-group-action" title="Remove value" ng-click="removeDisjunctionValue(sliceCopy, $parent.$index, $index)">
                      <i class="fa fa-minus remove-action"></i>
                    </a>
                  </div>
                </span>
              </li>
              
              <li class="list-group-item slice-disjunction-value slice-disjunction-actions {{ !dis.disjunctionValues ? 'slice-disjunction-value-first' : '' }}">
                <a href class="slice-disjunction-action" title="Add value" ng-click="addDisjunctionValue(sliceCopy, $index)">
                  <i class="fa fa-plus add-action" ></i>
                </a>
              </li>
            </ul>
          </td>
        </tr> 
      </tbody>
    </table>
  </form>
  <form novalidate class="simple-form" ng-submit="addDisjunctionField(sliceCopy, newDisjunctionFieldName)">
    <table class="table table-condensed">
    <tbody>
      <tr>
        <td class="slice-add-field-td">
          <input type="text" class="form-control"
                 placeholder="Field name" ng-model="newDisjunctionFieldName">&nbsp;
          <a href title="Add field" ng-click="addDisjunctionField(sliceCopy, newDisjunctionFieldName)">
            &nbsp;<i class="fa fa-plus add-action"></i>&nbsp;Add&nbsp;field
          </a>
        </td>
      </tr>
    </tbody>
    </table>
  </form>
</div>